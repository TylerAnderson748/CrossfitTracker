rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is gym owner
    function isGymOwner(gymId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/gyms/$(gymId)) &&
             get(/databases/$(database)/documents/gyms/$(gymId)).data.ownerId == request.auth.uid;
    }

    // Check if user is gym coach
    function isGymCoach(gymId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/gyms/$(gymId)) &&
             get(/databases/$(database)/documents/gyms/$(gymId)).data.coachIds.hasAny([request.auth.uid]);
    }

    // Check if user is gym member
    function isGymMember(gymId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/gyms/$(gymId)) &&
             get(/databases/$(database)/documents/gyms/$(gymId)).data.memberIds.hasAny([request.auth.uid]);
    }

    // Check if user is gym staff (owner or coach)
    function isGymStaff(gymId) {
      return isGymOwner(gymId) || isGymCoach(gymId);
    }

    // Check if user is affiliated with gym (owner, coach, or member)
    function isGymAffiliated(gymId) {
      return isGymOwner(gymId) || isGymCoach(gymId) || isGymMember(gymId);
    }

    // ==========================================
    // USER DATA
    // ==========================================

    // Users collection
    // NOTE: Currently allows authenticated users to read other profiles for
    // leaderboards and member lists. RECOMMENDED IMPROVEMENT: Split into
    // /users (private) and /userProfiles (public: name, photo only).
    // Sensitive fields (email, subscription, stripeIds) should be in private collection.
    match /users/{userId} {
      // Allow reads for member lists and leaderboards (see note above)
      allow read: if isAuthenticated();
      // Users can only write their own profile
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // ==========================================
    // GYMS & MEMBERSHIP
    // ==========================================

    // Gyms collection
    match /gyms/{gymId} {
      // Anyone authenticated can read gyms (for browsing/finding gyms)
      allow read: if isAuthenticated();

      // Anyone authenticated can create a gym (they become the owner)
      allow create: if isAuthenticated() &&
                       request.resource.data.ownerId == request.auth.uid;

      // Only owner can update gym
      allow update: if isGymOwner(gymId);

      // Only owner can delete gym
      allow delete: if isGymOwner(gymId);
    }

    // Gym Membership Requests collection
    match /gymMembershipRequests/{requestId} {
      // Users can create their own membership requests
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'pending';

      // Users can read their own requests, gym owners can read requests for their gyms
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid ||
                      isGymOwner(resource.data.gymId));

      // Only gym owners can update requests (approve/deny)
      allow update: if isGymOwner(resource.data.gymId);

      // Users can delete their own pending requests, owners can delete any requests for their gym
      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        isGymOwner(resource.data.gymId));
    }

    // Group Membership Requests collection
    match /groupMembershipRequests/{requestId} {
      // Users can create their own group membership requests
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'pending';

      // Users can read their own requests, gym owners/coaches can read requests for their gyms
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid ||
                      isGymStaff(resource.data.gymId));

      // Gym owners and coaches can update requests (approve/deny)
      allow update: if isGymStaff(resource.data.gymId);

      // Users can delete their own pending requests, owners/coaches can delete any requests for their gym
      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        isGymStaff(resource.data.gymId));
    }

    // Groups collection - only gym staff can manage
    match /groups/{groupId} {
      // Gym members can read their gym's groups
      allow read: if isAuthenticated() &&
                     (resource.data.gymId == null || isGymAffiliated(resource.data.gymId));

      // Only gym staff can create groups
      allow create: if isAuthenticated() &&
                       (request.resource.data.gymId == null || isGymStaff(request.resource.data.gymId));

      // Only gym staff can update/delete groups
      allow update: if isAuthenticated() &&
                       (resource.data.gymId == null || isGymStaff(resource.data.gymId));
      allow delete: if isAuthenticated() &&
                       (resource.data.gymId == null || isGymStaff(resource.data.gymId));
    }

    // ==========================================
    // WORKOUTS & PROGRAMMING
    // ==========================================

    // Workouts collection - personal workouts
    match /workouts/{workoutId} {
      // Users can read all workouts (for sharing/templates)
      allow read: if isAuthenticated();

      // Users can only create workouts they own
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Users can only update/delete their own workouts
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // Workout logs collection - user's workout history
    match /workoutLogs/{logId} {
      // Users can read all logs (for leaderboards/community)
      allow read: if isAuthenticated();

      // Users can only create logs for themselves
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Users can only update/delete their own logs
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // Weekly plans collection - personal plans
    match /weeklyPlans/{planId} {
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // Workout templates collection
    match /workoutTemplates/{templateId} {
      // Anyone can read templates (shared resource)
      allow read: if isAuthenticated();

      // Users can only create templates they own
      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.uid;

      // Users can only update/delete their own templates
      allow update: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid;
    }

    // Scheduled workouts collection (gym programming)
    match /scheduledWorkouts/{workoutId} {
      // Gym members can read their gym's scheduled workouts
      allow read: if isAuthenticated() &&
                     isGymAffiliated(resource.data.gymId);

      // Only gym staff can create scheduled workouts
      allow create: if isAuthenticated() &&
                       isGymStaff(request.resource.data.gymId);

      // Only gym staff can update scheduled workouts
      // Also allow members to update for signups (timeSlots field only)
      allow update: if isAuthenticated() &&
                       (isGymStaff(resource.data.gymId) ||
                        (isGymMember(resource.data.gymId) &&
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['timeSlots'])));

      // Only gym staff can delete scheduled workouts
      allow delete: if isAuthenticated() &&
                       isGymStaff(resource.data.gymId);
    }

    // AI Programming Sessions collection - creator only
    match /aiProgrammingSessions/{sessionId} {
      allow read: if isAuthenticated() &&
                     resource.data.createdBy == request.auth.uid;
      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.uid;
      allow update: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid;
      allow delete: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid;
    }

    // AI Programming Preferences collection - gym staff only
    match /aiProgrammingPreferences/{prefId} {
      allow read: if isAuthenticated() &&
                     isGymStaff(resource.data.gymId);
      allow create: if isAuthenticated() &&
                       isGymStaff(request.resource.data.gymId);
      allow update: if isAuthenticated() &&
                       isGymStaff(resource.data.gymId);
      allow delete: if isAuthenticated() &&
                       isGymStaff(resource.data.gymId);
    }

    // Workout Groups collection - gym staff only
    match /workoutGroups/{groupId} {
      allow read: if isAuthenticated() &&
                     isGymAffiliated(resource.data.gymId);
      allow create: if isAuthenticated() &&
                       isGymStaff(request.resource.data.gymId);
      allow update: if isAuthenticated() &&
                       isGymStaff(resource.data.gymId);
      allow delete: if isAuthenticated() &&
                       isGymStaff(resource.data.gymId);
    }

    // Personal/Saved Workouts collection
    match /personalWorkouts/{docId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ==========================================
    // EXTERNAL PROGRAMMING SOURCES
    // ==========================================

    // Programming sources (gyms, online programs, PTs, etc.)
    match /programmingSources/{sourceId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Programmed workouts from external sources
    match /programmedWorkouts/{workoutId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Connected programs - user's own connections only
    match /connectedPrograms/{docId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ==========================================
    // RESULTS & TRACKING
    // ==========================================

    // Lift Results collection
    match /liftResults/{resultId} {
      // Anyone can read for leaderboards
      allow read: if isAuthenticated();

      // Users can only create their own results
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Users can only update/delete their own results
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // Skill Results collection
    match /skillResults/{resultId} {
      // Anyone can read for leaderboards
      allow read: if isAuthenticated();

      // Users can only create their own results
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Users can only update/delete their own results
      allow update, delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }

    // Leaderboard entries collection - users can only manage their own entries
    match /leaderboardEntries/{entryId} {
      // Anyone can read for leaderboard display
      allow read: if isAuthenticated();

      // Users can only create entries for themselves
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Users can only update/delete their own entries
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }
  }
}
