rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Get gym document safely
    function getGym(gymId) {
      return get(/databases/$(database)/documents/gyms/$(gymId));
    }

    function gymExists(gymId) {
      return gymId != null && exists(/databases/$(database)/documents/gyms/$(gymId));
    }

    function isGymOwner(gymId) {
      return isAuthenticated() &&
             gymExists(gymId) &&
             getGym(gymId).data.ownerId == request.auth.uid;
    }

    function isGymCoach(gymId) {
      return isAuthenticated() &&
             gymExists(gymId) &&
             ('coachIds' in getGym(gymId).data) &&
             request.auth.uid in getGym(gymId).data.coachIds;
    }

    function isGymMember(gymId) {
      return isAuthenticated() &&
             gymExists(gymId) &&
             ('memberIds' in getGym(gymId).data) &&
             request.auth.uid in getGym(gymId).data.memberIds;
    }

    // Gym staff = owner OR coach (can write programming)
    function isGymStaff(gymId) {
      return isGymOwner(gymId) || isGymCoach(gymId);
    }

    // Gym affiliated = owner, coach, or member (can read gym content)
    function isGymAffiliated(gymId) {
      return isGymOwner(gymId) || isGymCoach(gymId) || isGymMember(gymId);
    }

    // Field validation helpers
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    function isValidString(field) {
      return request.resource.data[field] is string &&
             request.resource.data[field].size() > 0 &&
             request.resource.data[field].size() < 10000;
    }

    function isValidTimestamp(field) {
      return request.resource.data[field] is timestamp;
    }

    // Check if user is a super admin
    function isSuperAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin';
    }

    // ==========================================
    // USER DATA
    // ==========================================

    match /users/{userId} {
      // Authenticated users can read profiles (for member lookups)
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      // Owner can update their own profile, super admin can update roles
      allow update: if isOwner(userId) || isSuperAdmin();
      allow delete: if isOwner(userId);
    }

    // Public profiles - readable by authenticated users
    match /userProfiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // ==========================================
    // GYMS & MEMBERSHIP
    // ==========================================

    match /gyms/{gymId} {
      allow read: if isAuthenticated();

      // VULNERABILITY #3 FIX: Validate all fields on creation
      // Super admins can create gyms (when approving applications)
      allow create: if isAuthenticated() &&
                       (request.resource.data.ownerId == request.auth.uid || isSuperAdmin()) &&
                       hasRequiredFields(['name', 'ownerId', 'createdAt']) &&
                       isValidString('name') &&
                       request.resource.data.ownerId is string &&
                       // Ensure creator can't set themselves as member/coach on creation
                       (!('memberIds' in request.resource.data) || request.resource.data.memberIds == []) &&
                       (!('coachIds' in request.resource.data) || request.resource.data.coachIds == []);

      // Only owner or super admin can update gym settings
      allow update: if isGymOwner(gymId) || isSuperAdmin();
      allow delete: if isGymOwner(gymId) || isSuperAdmin();
    }

    match /gymMembershipRequests/{requestId} {
      allow read: if isAuthenticated();
      // Only the requesting user can create their own request
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'gymId', 'status']);
      // Gym owner can approve/deny, requester can withdraw
      allow update: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        isGymOwner(resource.data.gymId));
      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        isGymOwner(resource.data.gymId));
    }

    match /groupMembershipRequests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        isGymStaff(resource.data.gymId));
      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        isGymStaff(resource.data.gymId));
    }

    // ==========================================
    // GYM APPLICATIONS (Requires Admin Approval)
    // ==========================================

    match /gymApplications/{applicationId} {
      // Any authenticated user can read (query filters by userId in app)
      allow read: if isAuthenticated();

      // Any authenticated user can apply to create a gym
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'pending' &&
                       hasRequiredFields(['userId', 'userEmail', 'gymName', 'gymAddress', 'gymCity', 'gymState', 'gymZip', 'status', 'submittedAt']);

      // Only super admins can update applications (approve/reject)
      allow update: if isSuperAdmin();

      // Super admins can delete applications
      allow delete: if isSuperAdmin();
    }

    match /groups/{groupId} {
      allow read: if isAuthenticated();
      // Must specify gymId and be gym staff to create groups
      allow create: if isAuthenticated() &&
                       hasRequiredFields(['gymId', 'name']) &&
                       isGymStaff(request.resource.data.gymId);
      allow update: if isAuthenticated() && isGymStaff(resource.data.gymId);
      allow delete: if isAuthenticated() && isGymStaff(resource.data.gymId);
    }

    // ==========================================
    // WORKOUTS & PROGRAMMING (Gym-scoped)
    // VULNERABILITY #1 FIX: Only gym staff can write
    // ==========================================

    match /workouts/{workoutId} {
      allow read: if isAuthenticated();

      // Personal workouts: user owns it
      // Gym workouts: must be gym staff
      allow create: if isAuthenticated() &&
                       (request.resource.data.userId == request.auth.uid ||
                        ('gymId' in request.resource.data && isGymStaff(request.resource.data.gymId)));

      allow update: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        ('gymId' in resource.data && isGymStaff(resource.data.gymId)));

      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        ('gymId' in resource.data && isGymStaff(resource.data.gymId)));
    }

    // VULNERABILITY #7 FIX: Validate workout logs
    match /workoutLogs/{logId} {
      allow read: if isAuthenticated();

      // Must be the user logging their own workout
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /weeklyPlans/{planId} {
      allow read: if isAuthenticated();

      // VULNERABILITY #1 FIX: Only gym staff can write gym plans
      allow create: if isAuthenticated() &&
                       hasRequiredFields(['gymId']) &&
                       isGymStaff(request.resource.data.gymId);
      allow update: if isAuthenticated() && isGymStaff(resource.data.gymId);
      allow delete: if isAuthenticated() && isGymStaff(resource.data.gymId);
    }

    match /workoutTemplates/{templateId} {
      allow read: if isAuthenticated();

      // Personal templates or gym templates
      allow create: if isAuthenticated() &&
                       (request.resource.data.createdBy == request.auth.uid ||
                        ('gymId' in request.resource.data && isGymStaff(request.resource.data.gymId)));
      allow update: if isAuthenticated() &&
                       (resource.data.createdBy == request.auth.uid ||
                        ('gymId' in resource.data && isGymStaff(resource.data.gymId)));
      allow delete: if isAuthenticated() &&
                       (resource.data.createdBy == request.auth.uid ||
                        ('gymId' in resource.data && isGymStaff(resource.data.gymId)));
    }

    match /scheduledWorkouts/{workoutId} {
      allow read: if isAuthenticated();

      // VULNERABILITY #1 FIX: Only gym staff can schedule workouts
      allow create: if isAuthenticated() &&
                       hasRequiredFields(['gymId']) &&
                       isGymStaff(request.resource.data.gymId);
      allow update: if isAuthenticated() && isGymStaff(resource.data.gymId);
      allow delete: if isAuthenticated() && isGymStaff(resource.data.gymId);
    }

    // ==========================================
    // AI PROGRAMMING (VULNERABILITY #2 FIX)
    // ==========================================

    match /aiProgrammingSessions/{sessionId} {
      allow read: if isAuthenticated();

      // Must be gym staff to create AI sessions for a gym
      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.uid &&
                       hasRequiredFields(['gymId', 'createdBy']) &&
                       isGymStaff(request.resource.data.gymId);

      // Only creator (who is gym staff) can modify
      allow update: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid &&
                       isGymStaff(resource.data.gymId);
      allow delete: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid &&
                       isGymStaff(resource.data.gymId);
    }

    match /aiProgrammingPreferences/{prefId} {
      allow read: if isAuthenticated();

      // VULNERABILITY #2 FIX: Only gym staff can modify AI preferences
      allow create: if isAuthenticated() &&
                       hasRequiredFields(['gymId']) &&
                       isGymStaff(request.resource.data.gymId);
      allow update: if isAuthenticated() && isGymStaff(resource.data.gymId);
      allow delete: if isAuthenticated() && isGymStaff(resource.data.gymId);
    }

    match /workoutGroups/{groupId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() &&
                       hasRequiredFields(['gymId']) &&
                       isGymStaff(request.resource.data.gymId);
      allow update: if isAuthenticated() && isGymStaff(resource.data.gymId);
      allow delete: if isAuthenticated() && isGymStaff(resource.data.gymId);
    }

    match /personalWorkouts/{docId} {
      allow read: if isAuthenticated();
      // Only owner can write personal workouts
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ==========================================
    // EXTERNAL PROGRAMMING SOURCES
    // ==========================================

    match /programmingSources/{sourceId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /programmedWorkouts/{workoutId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /connectedPrograms/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ==========================================
    // RESULTS & TRACKING
    // ==========================================

    match /liftResults/{resultId} {
      allow read: if isAuthenticated();
      // Only owner can write their results
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'liftName', 'weight']);
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /skillResults/{resultId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'skillName']);
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // VULNERABILITY #4 FIX: Leaderboard with validation
    match /leaderboardEntries/{entryId} {
      allow read: if isAuthenticated();

      // Must be own entry with required fields
      // App sends: userId, workoutLogId, normalizedWorkoutName, timeInSeconds (or rounds/reps), createdAt
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       hasRequiredFields(['userId', 'workoutLogId', 'normalizedWorkoutName']);

      // Can only update own entries
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ==========================================
    // SUBSCRIPTIONS (Read-only from client)
    // ==========================================

    match /subscriptions/{subId} {
      // Users can read their own subscriptions
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // No client-side writes - subscriptions managed by Stripe webhooks
      allow create, update, delete: if false;
    }

    match /customers/{customerId} {
      allow read: if isOwner(customerId);
      allow create, update, delete: if false;
    }

    // ==========================================
    // CATCH-ALL: DENY EVERYTHING ELSE
    // ==========================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
